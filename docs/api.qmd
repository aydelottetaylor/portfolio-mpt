---
title: "API Reference"
format: html
toc: true
toc-depth: 3
---

This page documents the public functions, classes, and modules in the **portfolio-mpt** package.  

The API is organized into logical modules for:

- Data handling  (portfolio_mpt.data)  
- Wrangling  (portfolio_mpt.wrangle)  
- Analysis  (portfolio_mpt.analysis)  
- Optimization  (portfolio_mpt.optimize)  
- Visualization  (portfolio_mpt.viz)  
- Cleaning  (portfolio_mpt.clean)  
- Command-line interface  (portfolio_mpt.cli)

---

# `portfolio_mpt.data`

Utilities for fetching, storing, cleaning, and loading historical stock data.

---

### `FetchSpec`
**A dataclass describing a data request.**

```python
@dataclass
class FetchSpec:
    tickers: list[str]
    start: str
    end: str
    interval: str = "1d"
```

#### Fields
- **tickers** — list of asset tickers  
- **start, end** — date strings `"YYYY-MM-DD"`  
- **interval** — `"1d"`, `"1wk"`, `"1mo"`, etc.

---

### `fetch_prices(spec, force=False, clean=False)`
Download price data for all tickers in a `FetchSpec`.

#### Parameters
- **spec** — a `FetchSpec` instance  
- **force** — ignore cached files and re-download  
- **clean** — automatically clean the newly downloaded parquet  

#### Returns
- `DataFrame` - Adjusted closing prices indexed by datetime.

---

### `load_latest_for(tickers)`
Load the most recent **raw** parquet for the given tickers.  

#### Parameters
- **tickers** `(Iterable[str])` - Tickers to search for

#### Returns
- `DataFrame` or `None` - Loaded prices or None if no match exists

---

### `load_cleaned_for(tickers)`
Load the most recent **cleaned** parquet for the given tickers.  

#### Parameters
- **tickers** `(Iterable[str])` - Desired tickers

#### Returns
- `DataFrame` or `None` - Cleaned prices or None

---

---

# `portfolio_mpt.wrangle`

Tools for transforming raw price data into returns.

---

### `to_returns(prices, method="simple", benchmark=None)`
Compute asset returns.

#### Parameters
- **prices** `(DataFrame)` - Price Data  
- **method** `(str)` - 'simple', 'log', or 'excess'  
- **benchmark** `(str or Series, optional)` - For excess returns

#### Returns
- `DataFrame` - Return series

#### Methods
- `"simple"` – percent change  
- `"log"` – log returns  
- `"excess"` – excess returns vs benchmark

---

### `cumulative_returns(returns)`
Compute cumulative return:

$$
(1 + r_t)^{\text{cumprod}} - 1
$$

#### Parameters
- **returns** `(DataFrame)`

#### Returns
- `DataFrame` - The cumulative returns

---

### `rolling_returns(returns, window=252)`
Rolling-window cumulative return.

#### Parameters
- **returns** `(DataFrame)`  
- **window** `(int)` - Lookback length

#### Returns
- `Series` - A series of rolling returns

---

### `log_to_simple(log_returns)`
Convert log returns → simple returns.

#### Parameters
- **log_returns** `(Series or DataFrame)`

#### Returns
- `Same type as input`

---

### `simple_to_log(simple_returns)`
Convert simple returns → log returns. 

#### Parameters
- **simple_returns** `(Series or DataFrame)`

#### Returns
- **Same type as input**

#### Raises 
- `ValueError` - If any return ≤ –100%.

---

---

# `portfolio_mpt.analysis`

Statistical estimation: expected returns, covariance, and portfolio metrics.

---

### `expected_returns(returns_df, method="mean", span=None, annualize=True)`
Estimate expected returns per asset.

#### Parameters
- **returns_df** `(DataFrame)`  
- **method** `(str)` - 'mean' or 'ema'  
- **span** `(int, optional)` - Required for EMA  
- **annualize** `(bool)` - Annualize or not

#### Returns
- `Series` - Expected returns per asset

#### Methods
- `"mean"` – arithmetic mean  
- `"ema"` – exponentially weighted average  

Returns an **annualized** return vector by default.

---

### `covariance(returns_df, method="sample", annualize=True)`
Compute covariance matrix using:  
- sample covariance  
- Ledoit–Wolf shrinkage (optional)

#### Parameters
- **returns_df** `(DataFrame)`  
- **method** `(str)` - 'sample' or 'ledoit_wolf'  
- **annualize** `(bool)` - Annualize or not

#### Returns
- `DataFrame` - Covariance matrix

Annualized by default.

---

### `portfolio_metrics(weights, mu, Sigma, rf=0.0)`

#### Parameters
- **weights** `(array-like)` - Must sum to 1  
- **mu** `(Series)` - Expected returns  
- **Sigma** `(DataFrame)` - Covariance  
- **rf** `(float)` - Risk-free rate

#### Returns
Return a dictionary of:  
- **ret** — expected return  
- **vol** — volatility  
- **sharpe** — Sharpe ratio  

Weights must sum to 1.

---

---

# `portfolio_mpt.optimize`

Modern Portfolio Theory optimization tools.

---

### `OptResult`

Dataclass storing optimization output:  
- `weights`
- `ret`
- `vol`
- `sharpe`
- `success`
- `message`

---

### `global_min_variance(mu, Sigma)`
Compute the **minimum-variance portfolio**.

#### Parameters
- **mu** `(Series)`  
- **DataFrame** `(DataFrame)`

#### Returns
- `OptResult`

---

### `max_sharpe(mu, Sigma, rf=0.0)`
Compute the **maximum Sharpe ratio portfolio**.

#### Parameters
- **mu** `(Series)`  
- **Sigmna** `(DataFrame)`  
- **rf** `(Float)` - Rist-free rate

#### Returns
- `OptResult`

---

### `optimize_for_target_return(mu, Sigma, target)`
Find the lowest-volatility portfolio achieving a specific expected return.

#### Parameters
- **mu** `(Series)`  
- **Sigma** `(DataFrame)`  
- **target** `(Float)`

#### Returns
- `OptResult`

---

### `efficient_frontier(mu, Sigma, n_points=30)`
Classical target-return efficient frontier.

#### Parameters
- **mu** `(Series)`  
- **Sigma** `(DataFrame)`  
- **n_points** `(int)`

#### Returns
- `list[OptResult]`

---

### `frontier_risk_aversion(mu, Sigma, lambdas=None)`
Recommended smooth frontier method.

Sweeps risk-aversion levels:

$$
\min_w \; \lambda w^\top \Sigma w - w^\top \mu
$$

Produces a convex frontier that always includes the Max Sharpe portfolio.

#### Parameters
- **mu** `(Series)`  
- **Sigma** `(DataFrame)`  
- **lambdas** `(array-like, optional)`

#### Returns
- `list[OptResult]`

---

---

# `portfolio_mpt.viz`

Matplotlib-based plotting helpers.

---

### `line(df, title="Prices")`
Simple wrapper to plot price or return series.

#### Parameters
- **df** `(DataFrame)`  
- **title** `(str)`

#### Returns
- `AxesSubplot`

---

### `efficient_frontier_plot(results, ms=None, cml=False, rf=0.0)`
Plot an efficient frontier using matplotlib.

#### Parameters
- **results** `(list[OptResult])`  
- **ms** `(OptResult, optional)`  
- **cml** `(bool)`  
- **rf** `(float)`

#### Returns
- `AxesSubplot`

---

---

# `portfolio_mpt.clean`

Cleaning utilities for parquet price files.

---

### `clean_price_file(raw_path)`
Cleans a single parquet file:  
- Fix timestamps  
- Remove duplicates  
- Reindex to daily frequency  
- Forward/backward fill  
- Save cleaned version + manifest  

#### Parameters
- **raw_path** `(str or Path)` - Path to raw parquet file

#### Returns
- `Path` - Cleaned parquet path

---

### `clean_all_raw()`
Clean **all** files in `data/raw/` and save them into `data/clean/`.

#### Parameters
- **None**

#### Returns
- `list[Path]`

---

---

# `portfolio_mpt.cli`

Command-line interface for quick data pulls.

---

### `portfolio-mpt data-spike`
Download demo tickers and display a quick price plot.

#### Example
```bash
portfolio-mpt data-spike --tickers AAPL MSFT NVDA
```

Useful for confirming installation & testing data access.

---
